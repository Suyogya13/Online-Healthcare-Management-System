import javafx.application.Application;
import javafx.geometry.Insets;
import javafx.geometry.Pos;
import javafx.scene.Scene;
import javafx.scene.control.*;
import javafx.scene.layout.*;
import javafx.stage.Stage;

import java.util.*;
import java.util.concurrent.atomic.AtomicLong;
public class HealthcareApp extends Application {
    private final Map<Long, User> users = new HashMap<>();
    private final Map<Long, Appointment> appointments = new HashMap<>();
    private final AtomicLong userIdGen = new AtomicLong(1);
    private final AtomicLong apptIdGen = new AtomicLong(1);
    private User currentUser;
    private Stage primaryStage;
    public static void main(String[] args) {
        launch(args);
    }
    @Override
    public void start(Stage stage) {
        this.primaryStage = stage;
        seedDemoData();
        stage.setTitle("Online Healthcare Management - JavaFX Demo");
        showLoginScene();
        stage.show();
    }
    private void showLoginScene() {
        Label lblTitle = new Label("Online Healthcare Management");
        lblTitle.setStyle("-fx-font-size: 18px; -fx-font-weight: bold;");
        TextField usernameField = new TextField();
        usernameField.setPromptText("Username");
        PasswordField passwordField = new PasswordField();
        passwordField.setPromptText("Password");

        Button btnLogin = new Button("Login");
        Button btnRegister = new Button("Register");

        Label message = new Label();

        btnLogin.setOnAction(e -> {
            String u = usernameField.getText().trim();
            String p = passwordField.getText().trim();
            User auth = authenticate(u, p);
            if (auth == null) {
                message.setText("Invalid credentials.");
            } else {
                currentUser = auth;
                message.setText("");
                if (auth.getRole() == Role.PATIENT) showPatientDashboard();
                else showDoctorDashboard();
            }
        });

        btnRegister.setOnAction(e -> showRegisterScene());

        VBox vbox = new VBox(10, lblTitle, usernameField, passwordField, new HBox(10, btnLogin, btnRegister), message);
        vbox.setAlignment(Pos.CENTER);
        vbox.setPadding(new Insets(20));
        Scene scene = new Scene(vbox, 480, 300);
        primaryStage.setScene(scene);
    }

    private void showRegisterScene() {
        Label lbl = new Label("Register New User");
        TextField fullName = new TextField(); fullName.setPromptText("Full Name");
        TextField username = new TextField(); username.setPromptText("Username");
        PasswordField password = new PasswordField(); password.setPromptText("Password");
        ComboBox<String> roleBox = new ComboBox<>();
        roleBox.getItems().addAll("PATIENT", "DOCTOR");
        roleBox.setValue("PATIENT");

        Label msg = new Label();
        Button btnSubmit = new Button("Register");
        Button btnBack = new Button("Back");

        btnSubmit.setOnAction(e -> {
            String fn = fullName.getText().trim();
            String un = username.getText().trim();
            String pw = password.getText().trim();
            String role = roleBox.getValue();
            if (fn.isEmpty() || un.isEmpty() || pw.isEmpty()) {
                msg.setText("Please fill all fields.");
                return;
            }
            if (findUserByUsername(un) != null) {
                msg.setText("Username already exists.");
                return;
            }
            Role r = "DOCTOR".equals(role) ? Role.DOCTOR : Role.PATIENT;
            register(un, pw, fn, r);
            msg.setText("Registration successful. Go back to login.");
            fullName.clear(); username.clear(); password.clear();
        });

        btnBack.setOnAction(e -> showLoginScene());

        VBox v = new VBox(10, lbl, fullName, username, password, roleBox, new HBox(10, btnSubmit, btnBack), msg);
        v.setPadding(new Insets(20));
        v.setAlignment(Pos.CENTER_LEFT);
        Scene s = new Scene(v, 520, 360);
        primaryStage.setScene(s);
    }

    private void showPatientDashboard() {
        Label h = new Label("Patient Dashboard - " + currentUser.getFullName());
        h.setStyle("-fx-font-size: 16px; -fx-font-weight: bold;");

        Button btnViewAppts = new Button("My Appointments");
        Button btnLogout = new Button("Logout");

        btnViewAppts.setOnAction(e -> showPatientAppointmentsScene());
        btnLogout.setOnAction(e -> { currentUser = null; showLoginScene(); });

        HBox top = new HBox(10, h, new Region(), btnViewAppts, btnLogout);
        HBox.setHgrow(top.getChildren().get(1), Priority.ALWAYS);
        top.setPadding(new Insets(10));

        VBox root = new VBox(10, top, new Label("Welcome to the demo patient dashboard. Use buttons above."));
        root.setPadding(new Insets(10));

        Scene s = new Scene(root, 700, 400);
        primaryStage.setScene(s);
    }

    private void showDoctorDashboard() {
        Label h = new Label("Doctor Dashboard - " + currentUser.getFullName());
        h.setStyle("-fx-font-size: 16px; -fx-font-weight: bold;");

        Button btnViewAppts = new Button("View Assigned Appointments");
        Button btnLogout = new Button("Logout");

        btnViewAppts.setOnAction(e -> showDoctorAppointmentsScene());
        btnLogout.setOnAction(e -> { currentUser = null; showLoginScene(); });

        HBox top = new HBox(10, h, new Region(), btnViewAppts, btnLogout);
        HBox.setHgrow(top.getChildren().get(1), Priority.ALWAYS);
        top.setPadding(new Insets(10));

        VBox root = new VBox(10, top, new Label("Welcome to the demo doctor dashboard. Use buttons above."));
        root.setPadding(new Insets(10));

        Scene s = new Scene(root, 700, 400);
        primaryStage.setScene(s);
    }

    private void showPatientAppointmentsScene() {
        Label title = new Label("Book / View Appointments");
        title.setStyle("-fx-font-size: 14px; -fx-font-weight: bold;");

        // Doctor selection
        ComboBox<User> doctorCombo = new ComboBox<>();
        getAllDoctors().forEach(doctorCombo.getItems()::add);
        doctorCombo.setPromptText("Select Doctor");

        TextField datetimeField = new TextField();
        datetimeField.setPromptText("Enter date/time e.g. 2025-11-24 10:30");

        Button btnBook = new Button("Book Appointment");
        Label msg = new Label();

        btnBook.setOnAction(e -> {
            User doc = doctorCombo.getValue();
            String dt = datetimeField.getText().trim();
            if (doc == null || dt.isEmpty()) {
                msg.setText("Select doctor and enter date/time.");
                return;
            }
            createAppointment(currentUser.getId(), doc.getId(), dt);
            msg.setText("Appointment requested.");
            refreshPatientTable();
        });

        TableView<Appointment> table = new TableView<>();
        TableColumn<Appointment, String> colId = new TableColumn<>("ID");
        colId.setCellValueFactory(c -> javafx.beans.property.SimpleStringProperty.valueOf(String.valueOf(c.getValue().getId())));
        TableColumn<Appointment, String> colDoctor = new TableColumn<>("Doctor");
        colDoctor.setCellValueFactory(c -> javafx.beans.property.SimpleStringProperty.valueOf(findUserById(c.getValue().getDoctorId()).getFullName()));
        TableColumn<Appointment, String> colDT = new TableColumn<>("Date/Time");
        colDT.setCellValueFactory(c -> javafx.beans.property.SimpleStringProperty.valueOf(c.getValue().getDateTime()));
        TableColumn<Appointment, String> colStatus = new TableColumn<>("Status");
        colStatus.setCellValueFactory(c -> javafx.beans.property.SimpleStringProperty.valueOf(c.getValue().getStatus().toString()));

        table.getColumns().addAll(colId, colDoctor, colDT, colStatus);

        Button btnBack = new Button("Back");
        btnBack.setOnAction(e -> showPatientDashboard());

        VBox layout = new VBox(10, title,
                new HBox(10, doctorCombo, datetimeField, btnBook),
                msg, table, btnBack);
        layout.setPadding(new Insets(10));
        Scene s = new Scene(layout, 800, 500);

        // helper to refresh table contents
        Runnable refresh = this::noop;
        refresh = () -> {
            table.getItems().clear();
            table.getItems().addAll(findAppointmentsByPatient(currentUser.getId()));
        };
        // keep reference
        refreshPatientTable = refresh;

        refresh.run();
        primaryStage.setScene(s);
    }

    // placeholder to hold lambda for refreshing patient table
    private Runnable refreshPatientTable = this::noop;
    private void noop() { /* noop */ }

    private void showDoctorAppointmentsScene() {
        Label title = new Label("Appointments Assigned To You");
        title.setStyle("-fx-font-size: 14px; -fx-font-weight: bold;");

        TableView<Appointment> table = new TableView<>();
        TableColumn<Appointment, String> colId = new TableColumn<>("ID");
        colId.setCellValueFactory(c -> javafx.beans.property.SimpleStringProperty.valueOf(String.valueOf(c.getValue().getId())));
        TableColumn<Appointment, String> colPatient = new TableColumn<>("Patient");
        colPatient.setCellValueFactory(c -> javafx.beans.property.SimpleStringProperty.valueOf(findUserById(c.getValue().getPatientId()).getFullName()));
        TableColumn<Appointment, String> colDT = new TableColumn<>("Date/Time");
        colDT.setCellValueFactory(c -> javafx.beans.property.SimpleStringProperty.valueOf(c.getValue().getDateTime()));
        TableColumn<Appointment, String> colStatus = new TableColumn<>("Status");
        colStatus.setCellValueFactory(c -> javafx.beans.property.SimpleStringProperty.valueOf(c.getValue().getStatus().toString()));

        table.getColumns().addAll(colId, colPatient, colDT, colStatus);

        // Load data
        table.getItems().addAll(findAppointmentsByDoctor(currentUser.getId()));

        // Approve / Reject buttons
        Button btnApprove = new Button("Approve");
        Button btnReject = new Button("Reject");
        Button btnBack = new Button("Back");

        btnApprove.setOnAction(e -> {
            Appointment sel = table.getSelectionModel().getSelectedItem();
            if (sel != null) {
                sel.setStatus(Status.APPROVED);
                updateAppointment(sel);
                table.refresh();
            }
        });

        btnReject.setOnAction(e -> {
            Appointment sel = table.getSelectionModel().getSelectedItem();
            if (sel != null) {
                sel.setStatus(Status.REJECTED);
                updateAppointment(sel);
                table.refresh();
            }
        });

        btnBack.setOnAction(e -> showDoctorDashboard());

        HBox actions = new HBox(10, btnApprove, btnReject, btnBack);
        actions.setPadding(new Insets(10));

        VBox layout = new VBox(10, title, table, actions);
        layout.setPadding(new Insets(10));
        Scene s = new Scene(layout, 800, 500);
        primaryStage.setScene(s);
    }

    // -------------------------
    // Services / Utilities
    // -------------------------
    private void seedDemoData() {
        // admin-like not used in UI; just create doctor & patient demos
        register("dr_raj", "doc123", "Dr. Raj Sharma", Role.DOCTOR);
        register("dr_sita", "doc123", "Dr. Sita Verma", Role.DOCTOR);
        register("peter", "pass", "Peter Parker", Role.PATIENT);
        register("arya", "pass", "Arya Stark", Role.PATIENT);

        // a demo appointment
        createAppointment(findUserByUsername("peter").getId(),
                findUserByUsername("dr_raj").getId(),
                "2025-11-30 10:00");
    }

    private User register(String username, String password, String fullName, Role role) {
        long id = userIdGen.getAndIncrement();
        User u = new User(id, username, password, fullName, role);
        users.put(id, u);
        return u;
    }

    private User findUserByUsername(String username) {
        return users.values().stream()
                .filter(u -> u.getUsername().equalsIgnoreCase(username))
                .findFirst().orElse(null);
    }

    private User findUserById(Long id) {
        return users.get(id);
    }

    private User authenticate(String username, String password) {
        User u = findUserByUsername(username);
        if (u != null && u.getPassword().equals(password)) return u;
        return null;
    }

    private List<User> getAllDoctors() {
        List<User> list = new ArrayList<>();
        users.values().forEach(u -> { if (u.getRole() == Role.DOCTOR) list.add(u); });
        return list;
    }

    private Appointment createAppointment(Long patientId, Long doctorId, String dateTime) {
        long id = apptIdGen.getAndIncrement();
        Appointment a = new Appointment(id, patientId, doctorId, dateTime, Status.REQUESTED);
        appointments.put(id, a);
        return a;
    }

    private List<Appointment> findAppointmentsByPatient(Long patientId) {
        List<Appointment> list = new ArrayList<>();
        appointments.values().forEach(a -> { if (Objects.equals(a.getPatientId(), patientId)) list.add(a); });
        return list;
    }

    private List<Appointment> findAppointmentsByDoctor(Long doctorId) {
        List<Appointment> list = new ArrayList<>();
        appointments.values().forEach(a -> { if (Objects.equals(a.getDoctorId(), doctorId)) list.add(a); });
        return list;
    }

    private void updateAppointment(Appointment a) {
        appointments.put(a.getId(), a);
    }

    // -------------------------
    // Domain classes
    // -------------------------
    enum Role { PATIENT, DOCTOR }
    enum Status { REQUESTED, APPROVED, REJECTED }

    static class User {
        private final Long id;
        private final String username;
        private final String password;
        private final String fullName;
        private final Role role;

        public User(Long id, String username, String password, String fullName, Role role) {
            this.id = id; this.username = username; this.password = password;
            this.fullName = fullName; this.role = role;
        }
        public Long getId() { return id; }
        public String getUsername() { return username; }
        public String getPassword() { return password; }
        public String getFullName() { return fullName; }
        public Role getRole() { return role; }

        @Override
        public String toString() { return fullName + " (" + username + ")"; }
    }

    static class Appointment {
        private final Long id;
        private final Long patientId;
        private final Long doctorId;
        private final String dateTime;
        private Status status;

        public Appointment(Long id, Long patientId, Long doctorId, String dateTime, Status status) {
            this.id = id; this.patientId = patientId; this.doctorId = doctorId;
            this.dateTime = dateTime; this.status = status;
        }
        public Long getId() { return id; }
        public Long getPatientId() { return patientId; }
        public Long getDoctorId() { return doctorId; }
        public String getDateTime() { return dateTime; }
        public Status getStatus() { return status; }
        public void setStatus(Status status) { this.status = status; }
    }
}

